<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fine-Tuning as a Service</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <h1>Fine-Tuning as a Service</h1>
    <nav>
      <button class="tab-btn active" data-tab="upload">Upload</button>
      <button class="tab-btn" data-tab="train">Train</button>
      <button class="tab-btn" data-tab="jobs">Jobs</button>
      <button class="tab-btn" data-tab="infer">Infer</button>
      <button class="tab-btn" data-tab="download">Download</button>
    </nav>
  </header>

  <main>
    <!-- Upload -->
    <section id="upload" class="tab-content active">
      <h2>Upload Dataset</h2>
      <form id="uploadForm">
        <input type="text" id="datasetName" placeholder="Dataset name" required />
        <input type="file" id="datasetFile" required />
        <button type="submit">Upload</button>
      </form>
      <p id="uploadStatus"></p>
    </section>

    <!-- Train -->
    <section id="train" class="tab-content">
      <h2>Fine-Tune a Model</h2>

      <form id="trainForm">
        <!-- Base model dropdown -->
        <label for="baseModel">Base Model:</label>
        <select id="baseModel" required>
          <option>Loading models...</option>
        </select>

        <!-- Epochs -->
        <label for="epochs">Epochs:</label>
        <input type="number" id="epochs" min="1" value="1" required />

        <!-- Train button -->
        <button type="submit" id="trainBtn">Start Training</button>
      </form>

      <p id="trainStatus" class="status-msg"></p>
    </section>


    <!-- Jobs -->
    <section id="jobs" class="tab-content">
      <h2>Training Jobs</h2>
      <div id="jobsList"></div>

    </section>
    <!-- INFERENCE UI -->
    <section id="infer" class="tab-content">
      <h2>Run Inference</h2>

      <div class="infer-container">
        <!-- Model selector -->
        <div class="infer-row">
          <label>Trained Model:</label>
          <select id="modelSelect"></select>
        </div>

        <!-- Prompt + Button -->
        <div class="infer-row prompt-row">
          <textarea id="prompt" placeholder="Type your prompt here..."></textarea>

          <button id="runBtn" class="infer-btn">
            Generate Response
          </button>
        </div>

        <!-- Output -->
        <div id="result" class="chat-box"></div>
      </div>
    </section>


    <!-- Download -->
    <section id="download" class="tab-content">
      <h2>Download Adapter</h2>
      <form id="downloadForm">
        <input type="number" id="jobId" placeholder="Enter Job ID" required />
        <button type="submit">Download Adapter</button>
      </form>
      <p id="downloadStatus"></p>
    </section>
  </main>

  <footer>
    <p>Fine-Tuning as a Service Â© 2025 | Powered by FastAPI & Docker</p>
  </footer>
  <script>
    const API = "http://localhost:8000";

    /* ========== ðŸ”¹ Tab Switching ========== */
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {

        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");

        // Auto-refresh trained models only when Infer tab opens
        if (btn.dataset.tab === "infer") {
          loadTrainedModels();
        }
      });
    });


    /* ========== Upload Dataset ========== */
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("datasetName").value;
      const file = document.getElementById("datasetFile").files[0];
      if (!file) return alert("Please choose a dataset file.");

      const form = new FormData();
      form.append("name", name);
      form.append("file", file);

      const res = await fetch(`${API}/datasets/upload`, { method: "POST", body: form });
      const json = await res.json();

      if (json.id) {
        document.getElementById("uploadStatus").textContent = `Uploaded: ${json.filename}`;
        localStorage.setItem("datasetId", json.id);
      } else {
        document.getElementById("uploadStatus").textContent = "Upload failed.";
      }
    });

    /* ========== Load Base Models (Train Tab) ========== */
    async function loadBaseModels() {
      const select = document.getElementById("baseModel");
      if (!select) return;
      select.innerHTML = "<option>Loading models...</option>";

      try {
        const res = await fetch(`${API}/models`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const models = await res.json();
        if (!Array.isArray(models)) throw new Error("Response is not an array");

        select.innerHTML = "";
        models.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id || m.name || "unknown";
          opt.textContent = m.display_name || m.name || m.id || "Unnamed Model";
          select.appendChild(opt);
        });
      } catch (err) {
        console.warn(" Failed to load models:", err);
        select.innerHTML = `
      <option value="sshleifer/tiny-gpt2">Tiny GPT-2</option>
      <option value="distilgpt2">DistilGPT-2</option>
      <option value="gpt2">GPT-2 Base</option>
      <option value="gpt2-medium">GPT-2 Medium</option>
      <option value="meta-llama/Llama-3.2-1B">LLaMA-3.2 1B</option>
      <option value="meta-llama/Llama-3.1-7B">LLaMA-3.1 7B</option>
      <option value="mistralai/Mistral-7B-v0.1">Mistral 7B</option>
      <option value="Qwen/Qwen2.5-7B">Qwen 2.5 7B</option>
      <option value="google/gemma-2b">Gemma 2B</option> 
    `;
      }
    }

    /* ========== Start Fine-Tuning ========== */
    document.getElementById("trainForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const dataset_id = localStorage.getItem("datasetId");
      if (!dataset_id) return alert("Upload a dataset first!");

      const base_model = document.getElementById("baseModel").value;
      const epochs = document.getElementById("epochs").value;

      const form = new FormData();
      form.append("dataset_id", dataset_id);
      form.append("base_model", base_model);
      form.append("epochs", epochs);

      const status = document.getElementById("trainStatus");
      status.textContent = "Starting training...";

      try {
        const res = await fetch(`${API}/start_training/`, { method: "POST", body: form });
        const json = await res.json();

        if (json.job_id || json.id) {
          const jobId = json.job_id || json.id;
          localStorage.setItem("lastJobId", jobId);
          status.textContent = `Training started (Job ID: ${jobId})`;
          loadJobs();
        } else {
          status.textContent = `Training failed: ${json.detail || "Unknown error"}`;
        }
      } catch (err) {
        console.error(err);
        status.textContent = " Network or server error";
      }
    });

    /* ========== Load Jobs (Jobs Tab) ========== */
    async function loadJobs() {
      console.log("Loading jobs...");

      // Find container safely
      const container = document.getElementById("jobsList");
      if (!container) {
        console.error("ERROR: <div id='jobsList'> is missing in HTML.");
        return;
      }

      /*container.innerHTML = "<p>Loading jobs...</p>";*/

      try {
        // Correct backend route
        const res = await fetch(`${API}/jobs`);

        if (!res.ok) {
          container.innerHTML = `<p class='error'> Server error: HTTP ${res.status}</p>`;
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();

        // Ensure data is array
        if (!Array.isArray(data)) {
          container.innerHTML = `<p class='error'> Backend did not return a list</p>`;
          console.error("Invalid /jobs response:", data);
          return;
        }

        if (data.length === 0) {
          container.innerHTML = "<p>No training jobs yet.</p>";
          return;
        }

        // Render jobs
        container.innerHTML = data.map(job => `
      <div class="job-card">
        <h4>Job #${job.id}</h4>
        <p><b>Model:</b> ${job.base_model}</p>
        <p><b>Status:</b> ${job.status}</p>
        <p><b>Adapter:</b> ${job.adapter_path || "Not ready"}</p>
      </div>
    `).join("");

        console.log("Jobs loaded:", data);

      } catch (err) {
        console.error("Job load failed:", err);
        container.innerHTML = "<p class='error'> Could not load job list.</p>";
      }
    }
    // auto-refresh jobs every 3 seconds
    setInterval(loadJobs, 3000);
    /* ========== LOAD TRAINED MODELS INTO DROPDOWN ========== */
    async function loadTrainedModels() {
      const select = document.getElementById("modelSelect");

      try {
        const res = await fetch(`${API}/models/trained`);
        if (!res.ok) throw new Error("Failed to fetch trained models");

        const models = await res.json();

        select.innerHTML = ""; // clear

        if (models.length === 0) {
          select.innerHTML = `<option disabled>No trained models yet</option>`;
          return;
        }

        models.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.job_id;
          opt.textContent = `Job ${m.job_id} | ${m.base_model}`;
          select.appendChild(opt);
        });

        // Auto-select latest
        select.value = models[0].job_id;

      } catch (err) {
        console.error("Error loading trained models:", err);
        select.innerHTML = `<option disabled>Error loading models</option>`;
      }
    }
    /* ========== RUN INFERENCE WITH ANIMATION ========== */
    document.getElementById("runBtn").addEventListener("click", async () => {
      const btn = document.getElementById("runBtn");
      const prompt = document.getElementById("prompt").value.trim();
      const adapter_job_id = document.getElementById("modelSelect").value;
      const base_model = document.getElementById("baseModel").value;

      if (!prompt) return alert("Enter a prompt!");
      if (!adapter_job_id) return alert("No trained model selected!");

      //  Add animation
      btn.disabled = true;
      btn.innerHTML = `Generating <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>`;

      const form = new FormData();
      form.append("base_model", base_model);
      form.append("adapter_job_id", adapter_job_id);
      form.append("prompt", prompt);

      try {
        const res = await fetch(`${API}/infer`, { method: "POST", body: form });
        const json = await res.json();

        const out = document.getElementById("result");
        out.innerHTML += `<div class="user-msg">&gt; ${prompt}</div>`;
        out.innerHTML += `<div class="bot-msg">${json.response || "Error"}</div>`;
        out.scrollTop = out.scrollHeight;
      } catch (err) {
        console.error(err);
        alert("Inference failed! Check server logs.");
      }

      // Reset button
      btn.disabled = false;
      btn.innerHTML = "Generate Response";
    });

    /* ========== Download Adapter ========== */
    document.getElementById("downloadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const job_id = document.getElementById("jobId").value;
      if (!job_id) return alert("Enter a Job ID");

      const res = await fetch(`${API}/download/adapter/${job_id}`);
      const status = document.getElementById("downloadStatus");

      if (res.ok) {
        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `adapter_${job_id}.zip`;
        a.click();
        status.textContent = "Downloaded successfully!";
      } else {
        status.textContent = "Download failed or job not complete.";
      }
    });

    /* ========== Initialize Everything ========== */
    document.addEventListener("DOMContentLoaded", () => {
      loadBaseModels();
      loadJobs();
      loadTrainedModels(); 3
    });
  </script>
</body>

</html>